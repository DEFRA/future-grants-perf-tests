name: Performance Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'perf-test'
        type: choice
        options:
          - perf-test
          - dev
          - test
      test_duration:
        description: 'Test duration in seconds'
        required: true
        default: '300'
        type: string
      thread_count:
        description: 'Number of concurrent threads'
        required: true
        default: '10'
        type: string
      ramp_time:
        description: 'Ramp up time in seconds'
        required: true
        default: '5'
        type: string
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  pull-requests: write

jobs:
  gas-api-performance-test:
    name: GAS API Performance Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Install JMeter
        run: |
          wget https://downloads.apache.org//jmeter/binaries/apache-jmeter-5.6.3.tgz
          tar -xzf apache-jmeter-5.6.3.tgz
          sudo mv apache-jmeter-5.6.3 /opt/jmeter
          sudo ln -s /opt/jmeter/bin/jmeter /usr/local/bin/jmeter
          echo "JMeter installed successfully"
          jmeter --version

      - name: Set environment secrets
        run: |
          # Use GitHub secrets for API credentials
          echo "X_API_KEY=${{ secrets.FG_GAS_API_KEY }}" >> $GITHUB_ENV
          echo "AUTHORIZATION_TOKEN=${{ secrets.FG_GAS_AUTH_TOKEN }}" >> $GITHUB_ENV
          echo "::add-mask::${{ secrets.FG_GAS_API_KEY }}"
          echo "::add-mask::${{ secrets.FG_GAS_AUTH_TOKEN }}"

      - name: Create results directory
        run: mkdir -p test-results

      - name: Set test parameters
        run: |
          echo "THREAD_COUNT=${{ github.event.inputs.thread_count || '10' }}" >> $GITHUB_ENV
          echo "RAMP_TIME=${{ github.event.inputs.ramp_time || '5' }}" >> $GITHUB_ENV
          echo "TEST_DURATION=${{ github.event.inputs.test_duration || '300' }}" >> $GITHUB_ENV
          echo "ENVIRONMENT=${{ github.event.inputs.environment || 'perf-test' }}" >> $GITHUB_ENV

      - name: Verify secrets are set
        run: |
          if [ -z "$X_API_KEY" ]; then
            echo "âŒ FG_GAS_API_KEY secret is not set"
            echo "Please add FG_GAS_API_KEY to repository secrets"
            exit 1
          fi
          if [ -z "$AUTHORIZATION_TOKEN" ]; then
            echo "âŒ FG_GAS_AUTH_TOKEN secret is not set" 
            echo "Please add FG_GAS_AUTH_TOKEN to repository secrets"
            exit 1
          fi
          echo "âœ… All required secrets are configured"

      - name: Run GAS API Performance Tests
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          echo "ðŸš€ Running performance tests with:"
          echo "  Environment: ${ENVIRONMENT}"
          echo "  Threads: ${THREAD_COUNT}"
          echo "  Ramp Time: ${RAMP_TIME}s"
          echo "  Duration: ${TEST_DURATION}s"
          
          jmeter -n \
            -t scenarios/GAS_API_Test.jmx \
            -l test-results/gas_api_results_${TIMESTAMP}.jtl \
            -e -o test-results/html_report_${TIMESTAMP} \
            -JX_API_KEY="${X_API_KEY}" \
            -JAUTHORIZATION_TOKEN="${AUTHORIZATION_TOKEN}" \
            || true  # Don't fail the workflow if some tests fail

      - name: Generate Test Summary
        run: |
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          
          # Extract key metrics from JTL file
          TOTAL_SAMPLES=$(awk -F',' 'END {print NR-1}' test-results/gas_api_results_*.jtl)
          FAILED_SAMPLES=$(awk -F',' '$8=="false" {count++} END {print count+0}' test-results/gas_api_results_*.jtl)
          SUCCESS_RATE=$(awk -F',' 'BEGIN{total=0; success=0} NR>1{total++; if($8=="true") success++} END{if(total>0) print (success/total)*100; else print 0}' test-results/gas_api_results_*.jtl)
          
          # Calculate average response time
          AVG_RESPONSE_TIME=$(awk -F',' 'NR>1 {sum+=$2; count++} END {if(count>0) print sum/count; else print 0}' test-results/gas_api_results_*.jtl)
          
          echo "## Performance Test Results ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | $ENVIRONMENT |" >> $GITHUB_STEP_SUMMARY
          echo "| Total Samples | $TOTAL_SAMPLES |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed Samples | $FAILED_SAMPLES |" >> $GITHUB_STEP_SUMMARY
          echo "| Success Rate | ${SUCCESS_RATE}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Average Response Time | ${AVG_RESPONSE_TIME}ms |" >> $GITHUB_STEP_SUMMARY
          echo "| Thread Count | $THREAD_COUNT |" >> $GITHUB_STEP_SUMMARY
          echo "| Ramp Time | $RAMP_TIME seconds |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Duration | $TEST_DURATION seconds |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Add test status
          if [ "$FAILED_SAMPLES" -eq "0" ]; then
            echo "âœ… **All tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Some tests failed. Please check the detailed results.**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gas-api-performance-test-results-${{ github.run_number }}
          path: |
            test-results/
            !test-results/**/*.log
          retention-days: 30

      - name: Post results to Slack (if configured)
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -n "$SLACK_WEBHOOK_URL" ]; then
            TOTAL_SAMPLES=$(awk -F',' 'END {print NR-1}' test-results/gas_api_results_*.jtl)
            FAILED_SAMPLES=$(awk -F',' '$8=="false" {count++} END {print count+0}' test-results/gas_api_results_*.jtl)
            SUCCESS_RATE=$(awk -F',' 'BEGIN{total=0; success=0} NR>1{total++; if($8=="true") success++} END{if(total>0) print (success/total)*100; else print 0}' test-results/gas_api_results_*.jtl)
            
            if [ "$FAILED_SAMPLES" -eq "0" ]; then
              STATUS_EMOJI="âœ…"
              STATUS_TEXT="PASSED"
            else
              STATUS_EMOJI="âŒ"
              STATUS_TEXT="FAILED"
            fi
            
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"text\": \"$STATUS_EMOJI GAS API Performance Test $STATUS_TEXT\",
                \"blocks\": [
                  {
                    \"type\": \"section\",
                    \"text\": {
                      \"type\": \"mrkdwn\",
                      \"text\": \"*GAS API Performance Test Results*\n*Environment:* $ENVIRONMENT\n*Success Rate:* ${SUCCESS_RATE}%\n*Total Samples:* $TOTAL_SAMPLES\n*Failed:* $FAILED_SAMPLES\"
                    }
                  }
                ]
              }" \
              $SLACK_WEBHOOK_URL
          fi

      - name: Fail workflow if critical tests failed
        run: |
          FAILED_SAMPLES=$(awk -F',' '$8=="false" {count++} END {print count+0}' test-results/gas_api_results_*.jtl)
          SUCCESS_RATE=$(awk -F',' 'BEGIN{total=0; success=0} NR>1{total++; if($8=="true") success++} END{if(total>0) print (success/total)*100; else print 0}' test-results/gas_api_results_*.jtl)
          
          # Fail if success rate is below 95%
          if (( $(echo "$SUCCESS_RATE < 95" | bc -l) )); then
            echo "Performance test failed: Success rate ($SUCCESS_RATE%) is below 95%"
            exit 1
          fi