print("ğŸ” Starting scan and cleanup of test references...\n");

// Matches:
// - perf strings
// - case-ref-1767698381-1 style
// - 512-ba9-2e8 style
const CASE_REF_RE = /case-ref-\d{10,}-\d+/i;
const SHORT_REF_RE = /\b[a-f0-9]{3}-[a-f0-9]{3}-[a-f0-9]{3}\b/i;

// ğŸ‘‡ ONLY these collections will be scanned
const allowedCollections = (() => {
  const dbName = db.getName();

  if (dbName === "fg-gas-backend") {
    return ["inbox", "outbox", "applications"];
  }

  if (dbName === "fg-cw-backend") {
    return ["inbox", "outbox", "cases"];
  }

  throw new Error(
    `âŒ Refusing to run. Unknown DB: ${dbName}. Only allowed: fg-gas-backend, fg-cw-backend`
  );
})();

print(`âœ… Connected DB: ${db.getName()}`);
print(`âœ… Collections targeted: ${allowedCollections.join(", ")}\n`);

allowedCollections.forEach((collection) => {
  // skip if collection doesn't exist
  if (!db.getCollectionNames().includes(collection)) {
    print(`âš ï¸ Collection not found, skipping: ${collection}`);
    return;
  }

  const cursor = db.getCollection(collection).find({
    $where: function () {
      const docStr = JSON.stringify(this);

      return (
        docStr.includes("perf-test-client-ref") ||
        docStr.includes("frps-perf-test-client-ref") ||
        docStr.includes("client-perf") ||
        CASE_REF_RE.test(docStr) ||
        SHORT_REF_RE.test(docStr)
      );
    }
  });

  let count = 0;

  cursor.forEach((doc) => {
    db.getCollection(collection).deleteOne({ _id: doc._id });
    print(`ğŸ—‘ï¸ Deleted from ${collection}: ${doc._id}`);
    count++;
  });

  if (count > 0) {
    print(`âœ… ${count} matching docs deleted from: ${collection}\n`);
  } else {
    print(`â„¹ï¸ No matches in: ${collection}\n`);
  }
});

print("\nğŸ‰ Cleanup complete!");
